
PROCEDURE PROC_APPLICATION_HEADER_SEARCH
(
    P_SEARCH_KEY IN VARCHAR2,
    P_FROM IN VARCHAR2,
    P_TO IN VARCHAR2,
    P_SORT_TYPE IN VARCHAR2,
    P_TOTAL_RECORD OUT NUMBER,
    P_CURSOR OUT PKG_COMMON.T_CURSOR
)
IS
    V_SQL VARCHAR2(32000) DEFAULT '';
    V_CONDITION VARCHAR2(4000) DEFAULT '';
    V_TOTAL_COUNT VARCHAR2(32000) DEFAULT '';

    V_INDEX NUMBER DEFAULT 0;
    CURSOR V_CUR_CONDITION IS
        SELECT COLUMN_VALUE AS CONDITION FROM TABLE(FN_PARSER(P_SEARCH_KEY,'|'));

    V_STATUS VARCHAR2(3) DEFAULT 'ALL';
    V_APP_CODE VARCHAR2(10) DEFAULT 'ALL';
    V_MASTER_NAME VARCHAR2(100) DEFAULT 'ALL';

    V_FROM NUMBER ;
    V_TO NUMBER;
BEGIN


    -- LAY RA CAC DK TIM KIEM
    FOR ITEM IN V_CUR_CONDITION LOOP

        IF V_INDEX = 0 THEN
            V_APP_CODE := ITEM.CONDITION;
        ELSIF V_INDEX = 1 THEN
            V_STATUS := ITEM.CONDITION;
        ELSIF V_INDEX = 2 THEN
            V_MASTER_NAME := ITEM.CONDITION;
        END IF;

        V_INDEX := V_INDEX + 1;
    END LOOP;

    IF V_APP_CODE <> 'ALL' THEN
        V_CONDITION := V_CONDITION || ' AND A.APPCODE = ''' || V_APP_CODE || '''';
    END IF;

    IF V_STATUS <> 'ALL' THEN
        V_CONDITION := V_CONDITION || ' AND A.STATUS = ' || V_STATUS;
    END IF;

    IF V_MASTER_NAME <> 'ALL' THEN
        V_CONDITION :=  V_CONDITION || ' AND UPPER(A.MASTER_NAME) LIKE ''%' || UPPER(V_MASTER_NAME) || '%'' ';
    END IF;


    V_SQL := 'SELECT  A.*, AL1.CONTENT AS STATUS_NAME, AL2.CONTENT AS STATUS_FORMM_NAME, AL3.CONTENT AS STATUS_CONTENT_NAME,SA.APPNAME
      FROM APPLICATION_HEADER A
      JOIN SYS_APPLICATION SA ON SA.APPCODE = A.APPCODE AND A.LANGUAGUE_CODE = SA.LANGUAGECODE
      LEFT JOIN ALLCODE AL1 ON AL1.CDVAL = TO_CHAR(A.STATUS) AND AL1.CDNAME = ''APP'' AND AL1.CDTYPE = ''STATUS''
      LEFT JOIN ALLCODE AL2 ON AL2.CDVAL = A.STATUS_FORM AND AL2.CDNAME = ''APP'' AND AL2.CDTYPE = ''STATUS_FORM''
      LEFT JOIN ALLCODE AL3 ON AL3.CDVAL = A.STATUS_CONTENT AND AL3.CDNAME = ''APP'' AND AL3.CDTYPE = ''STATUS_CONTENT'' WHERE 1 = 1 ';

    V_SQL :=  V_SQL || V_CONDITION;

    IF P_SORT_TYPE <> 'ALL' THEN
        V_SQL :=  V_SQL || P_SORT_TYPE;
    ELSE
        V_SQL :=  V_SQL || ' ORDER BY A.APPCODE,A.CREATED_DATE';
    END IF;

    DBMS_OUTPUT.PUT_LINE(V_SQL);


    V_TOTAL_COUNT := 'SELECT COUNT(*) FROM (' || V_SQL || ')';
    EXECUTE IMMEDIATE V_TOTAL_COUNT INTO V_TOTAL_COUNT;

    V_FROM := P_FROM ;
    V_TO := P_TO;

    IF P_FROM = '0' AND P_TO = '0' THEN
        V_FROM := '1' ;
        V_TO := V_TOTAL_COUNT;
    END IF;

    V_SQL := 'SELECT * FROM ( SELECT ROWNUM STT, V.* FROM( ' || V_SQL || ') V ) A WHERE STT BETWEEN ' || V_FROM || ' AND ' || V_TO;
    OPEN P_CURSOR FOR V_SQL;

    PKG_LOG.LOGMSGALL(V_SQL);


    P_TOTAL_RECORD := V_TOTAL_COUNT;

EXCEPTION
WHEN OTHERS THEN
    RAISE;
END;
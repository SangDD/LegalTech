@using CommonData
@{
	ViewBag.Title = "Quản lý nhóm quyền";
	Layout = "~/ViewsShared/_Layout.cshtml";
}
@try
{
	<input type="hidden" value="LastTimeUpdated" id="colSorted" />
	<input type="hidden" value="DESC" id="SortType" />
	<input type="hidden" value="" id="OptionSorting" />

	<div class="d-popup-container" id="dpop-groupuser"></div>

	<div class="d-nav-container">
		<ul class="ul-nav">
			<li><a href="javascript:;">Quản trị hệ thống</a></li>
			<li><a href="/quan-tri-he-thong/quan-ly-nhom-quyen">Quản lý nhóm quyền</a></li>
		</ul>
	</div>

	<div class="title-section-content">
		<p class="font-size-15 text-font-medium">Danh sách nhóm quyền</p>
	</div>

	<div class="action">
		<input class="btn" type="button" value="Thêm mới nhóm quyền" onclick="getViewToAddNewGroupUser()" />
	</div>

	<div class="div-search grid-3cols">
		<div class="item-search">
			<label class="title-condition">Tên nhóm</label>
			<input class="control-condition" data-controlcondition="TRUE" type="text" id="txtGroupNameSearch"/>
		</div>
		<div class="item-search">
			<input id="btnFindGroupUsers" data-controlcondition="TRUE" type="button" class="btn btn-seach" value="Tìm kiếm" onclick="findGroupUsers(1, 1)" />
		</div>
	</div>

	<div id="divTableGroupUsers">
		@Html.Partial("_PartialTableListGroups")
	</div>

	<script>
		$(document).ready(function () {
			$('txtGroupNameSearch').focus();
			$('[data-controlcondition="TRUE"]').on('keypress',
				function (e) {
					enterKeyPress(e, 'btnFindGroupUsers');
				});

			window.__seasionstorage_keySearch = '@SessionStorages.SEARCH_GROUPUSER_KEY_CONDITIONS';
			window.__seasionstorage_optionFilter = '@SessionStorages.SEARCH_GROUPUSER_KEY_OPTIONS';
			var groupName = '';

			window.colSort = 'LastTimeUpdated';
			window.sortType = 'DESC';
			window.pageNumber = 1;
			window.recordPerPage = window.defaultRecordPerPage;
			updateFilterOption();
			window.keySearch = groupName + "|";
			initSessionStorage(findGroupUsers);
			bindColumnSortWithSearching(findGroupUsers);
			if (!pageContainDataOfSearching()) {
				ChangeIConSortWhenSortColumns();
			}
		});

		function findGroupUsers(_pageNumber, _isSearching) {
			window.__seasionstorage_keySearch = '@SessionStorages.SEARCH_GROUPUSER_KEY_CONDITIONS';
			window.__seasionstorage_optionFilter = '@SessionStorages.SEARCH_GROUPUSER_KEY_OPTIONS';
			window.keySearch = sessionStorage.getItem(window.__seasionstorage_keySearch);
			window.optionFilter = sessionStorage.getItem(window.__seasionstorage_optionFilter);
			window.pageNumber = _pageNumber;
			window.isSearching = _isSearching;
			var groupName;
			if (isSearching === 1) {
				window.pageNumber = 1;
				groupName = $("#txtGroupNameSearch").val().trim();
				setOptionFilter();
				window.recordPerPage = $("#divNumberRecordOnPageListGroups").val();
			} else {
				window.arrKeySearch = window.keySearch.split('|');
				window.arrOptionFilter = window.optionFilter.split('|');
				groupName = arrKeySearch[0];
				$("#txtGroupNameSearch").val(groupName);
				if (pageNumber === -1) {
					window.colSort = arrOptionFilter[0];
					window.sortType = arrOptionFilter[1];
					window.optionSorting = arrOptionFilter[2];
					window.pageNumber = arrOptionFilter[3];
					window.recordPerPage = arrOptionFilter[4];
					setOptionFilter();
					$("#divNumberRecordOnPageListGroups").val(recordPerPage);
				} else {
					setOptionFilter();
					window.recordPerPage = $("#divNumberRecordOnPageListGroups").val();
				}
			}

			window.keySearch = groupName + "|";
			sessionStorage.setItem(__seasionstorage_keySearch, keySearch);
			updateFilterOption();
			sessionStorage.setItem(__seasionstorage_optionFilter, optionFilter);

			$.ajax({
				type: "POST",
				headers: { "cache-control": "no-cache" },
				url: "/quan-tri-he-thong/quan-ly-nhom-quyen/find-group",
				data: {
					keysSearch: keySearch,
					options: optionFilter
				},
				async: false,
				success: function (data) {
					if (data != null) {
						if (onResponse(data)) {
							$("#divTableGroupUsers").html(data);
							ChangeIConSortWhenSortColumns();
							bindColumnSortWithSearching(findGroupUsers);
						}
					}
				}
			});
			return true;
		}

		function pageListOfGroups(_pagenum) {
			try {
				findGroupUsers(_pagenum, 0);

			} catch (e) {
				console.log(e.message);
			}
		}
	</script>

	@* task function *@
	<script>
	function getViewToAddNewGroupUser() {
		$.ajax({
			type: "POST",
			url: "/quan-tri-he-thong/quan-ly-nhom-quyen/get-view-to-add-group",
			headers: { "cache-control": "no-cache" },
			async: false,
			success: function (data) {
				if (data != null) {
					if (onResponse(data)) {
						$("#dpop-groupuser").html(data);
						ShowPopupDialog("dpop-groupuser", "Thêm mới nhóm quyền", 600, 0, "txtGroupNameAdd");
					}
				}
				return false;
			}
		});
	}

	function getViewToEditGroupUser(groupId, groupName) {
		$.ajax({
			type: "POST",
			url: "/quan-tri-he-thong/quan-ly-nhom-quyen/get-view-to-edit-group",
			headers: { "cache-control": "no-cache" },
			data: { groupId : groupId },
			async: false,
			success: function (data) {
				if (data != null) {
					if (onResponse(data)) {
						$("#dpop-groupuser").html(data);
						ShowPopupDialog("dpop-groupuser", "Sửa nhóm quyền: <span class='data-in-title-popup'>" + groupName + "</span>", 600, 0, "txtGroupNameEdit");
					}
				}
				return false;
			}
		});
	}

	function doDeleteGroupUser(groupId, numberUserInGroup) {
		if (numberUserInGroup > 0) {
			showError("Không thể xóa nhóm quyền đang tồn tại người dùng.");
			return false;
		} else {
			nvsConfirm(null, "Bạn có chắc chắn muốn xóa nhóm quyền này không?", function () {
				$.ajax({
					url: "/quan-tri-he-thong/quan-ly-nhom-quyen/do-delete-group",
					type: "POST",
					data: { groupId : groupId },
					headers: { "cache-control": "no-cache" },
					async: false,
					success: function (data) {
						if (data != null) {
							if (onResponse(data)) {
								if (data["DeleteGroupResult"]["isDeleteGroupSuccess"]) {
									showSuccess(data["DeleteGroupResult"]["message"]);
									ClosePopupDialog('dpop-groupuser', true);
									window.findGroupUsers(1, 0);
								} else {
									showError(data["DeleteGroupResult"]["message"]);
								}
							}
						}
					},
					error: function (e) {
						console.log(e);
					}
				});

			});
		}
	}

	function setupFunctionsToGroup(groupId, groupName) {
		$.ajax({
			type: "POST",
			url: "/quan-tri-he-thong/quan-ly-nhom-quyen/get-functions-in-group",
			headers: { "cache-control": "no-cache" },
			data: { groupId : groupId },
			async: false,
			success: function (data) {
				if (data != null) {
					if (onResponse(data)) {
						$("#dpop-groupuser").html(data);
						ShowPopupDialog("dpop-groupuser", "Phân quyền cho nhóm: <span class='data-in-title-popup'>" + groupName + "</span>", 600, 0, "");
					}
				}
				return false;
			}
		});
	}
	</script>
}
catch (Exception)
{
	// ignored
}